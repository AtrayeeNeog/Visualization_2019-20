---
title: "BigData-Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(plyr)
```

## Procurement Channel:

```{r cars}
# Load The Data:
bg23 <- data.table::fread(here::here("data", "BigGraphData", "procurement.csv"))

nrow(bg23)

head(bg23)
length(unique(bg23$Target))
length(unique(bg23$Source))

```



```{r}
#unique(bg23$Source) 
#unique(bg23$Target)

#bg23[bg23$Target==641131 & bg23$eType == 2]

#bg23$Time[bg23$Target==641131]

bg2 <- bg23 %>% filter(bg23$eType==2)
bg3 <- bg23 %>% filter(bg23$eType==3)

```

```{r}
items_sold <- count(bg2, c("Source","Target")) # Trying to find interesting items which were sold multiple times.
items_bought <- count(bg3, c("Source","Target")) # Trying to find interesting items which were bought multiple times.
# We need items which are sold and bought more than 7 times by the same people.

max(items_sold$freq)
min(items_sold$freq)
max(items_bought$freq)
min(items_bought$freq)
unique(items_sold$freq)

items_sold <- items_sold %>% filter(items_sold$freq >= 7)
items_bought <- items_bought %>% filter(items_bought$freq >= 7)

#items_sold$Source[items_sold$Target==643087]

```

```{r}
## Items which are both sold and bought more than 7 times:
frequent_items<-intersect(items_sold$Target, items_bought$Target)
```








```{r}
## Extracting the rows for which Targets belong to the list of common items which were both sold and bought:
# Don't run
for (i in bg23$Target) {
  for (j in frequent_items) {
    if(i==j){
      trans <- rbind(bg23[bg23$Target==j])
    } 
    
  }
  
}
trans
nrow(trans)


```


```{r}
for (i in bg23$Target) {
  if(i==525263){
    trans <- bg23[bg23$Target==525263]
  }
  
}
trans
```





```{r}
ggplot(trans, aes(x=as.character(Source), y=Time, color = as.character(eType), fill=as.character(eType))) + 
  geom_point(shape=23, size = 5)+theme(axis.text.x=element_text(size=10, angle=90))+labs(title="Source Target Combinations for Big Graph ",
                                    x="Source & Target Combination", y = "Time")
```

```{r}
# Sources which are similar to template.
# 487668:S:644830,585212
# 482264:S:595104,570284
# 657187:S:550287,512397
```

643087 589127 483999 520837 583906 555931 595800 597727 606994 569215 641131 590595 547205 631478 490745 552748 596301
492039 469675 554011 597461 651537 544444 499177 614798 511389 461577 482579 654011 567511 605235 467222 649122 604359
592419 525263 588802 485885 563055 544415 578918 560703 473475 586881 466410 543037 657187 482264 487668


```{r}
trans <- bg23[bg23$Target==487668]
ggplot(trans, aes(x=as.character(Source), y=Time, color = as.character(eType), fill=as.character(eType))) + 
  geom_point(shape=23, size = 5)+theme(axis.text.x=element_text(size=10, angle=90))+labs(title="Source Target Combinations for Big Graph ",
                                    x="Source & Target Combination", y = "Time")
```

```{r}
trans <- bg23[bg23$Target==482264]
ggplot(trans, aes(x=as.character(Source), y=Time, color = as.character(eType), fill=as.character(eType))) + 
  geom_point(shape=23, size = 5)+theme(axis.text.x=element_text(size=10, angle=90))+labs(title="Source Target Combinations for Big Graph ",
                                    x="Source & Target Combination", y = "Time")
```

```{r}
trans <- bg23[bg23$Target==657187]
ggplot(trans, aes(x=as.character(Source), y=Time, color = as.character(eType), fill=as.character(eType))) + 
  geom_point(shape=23, size = 5)+theme(axis.text.x=element_text(size=10, angle=90))+labs(title="Source Target Combinations for Big Graph ",
                                    x="Source & Target Combination", y = "Time")
```

```{r}
trans <- bg23[bg23$Target==567511]
ggplot(trans, aes(x=as.character(Source), y=Time, color = as.character(eType), fill=as.character(eType))) + 
  geom_point(shape=23, size = 5)+theme(axis.text.x=element_text(size=10, angle=90))+labs(title="Source Target Combinations for Big Graph ",
                                    x="Source & Target Combination", y = "Time")
```

## Travel Channel:

```{r}
# Load The Data:
bg6 <- data.table::fread(here::here("data", "BigGraphData", "eType6.csv"))

nrow(bg6)

head(bg6)
tail(bg6)
length(unique(bg6$Target))
length(unique(bg6$Source))
```


```{r}
colnames(bg6)
bg6 <- subset(bg6, select = -c(SourceLatitude, TargetLatitude, SourceLongitude, TargetLongitude))

bg6 <- bg6[!duplicated(bg6)]
nrow(bg6)
#bg6$Time <- floor(bg6$Time/(3600*7*24))
```

## Find the Locations visited at the same time:

```{r}
location_clusters <- count(bg6, c("Time"))
nrow(location_clusters)
min(location_clusters$freq)
max(location_clusters$freq)
unique(location_clusters$freq)
location_clusters <- location_clusters %>% filter(location_clusters$freq >2 )
#length(unique(location_clusters$Time))
#time <- unique(location_clusters$Time)
location_clusters$Source[location_clusters$freq==28] #643925
length(unique(location_clusters$Source))


```


```{r}
bg6[bg6$Time == 5961600 & bg6$Target == 499467 & bg6$SourceLocation ==0]
```





```{r}
target1 <- bg6 %>% filter(Target==509607 & SourceLocation == 3)
target2 <- bg6 %>% filter(Target==509607)
target3 <- bg6 %>% filter(Target==561157 & SourceLocation==0)
target4 <- bg6 %>% filter(Target==616453 & Time == 17915018)
target5 <- bg6 %>% filter(Target==625756 & Time == 17915018)
target6 <- bg6 %>% filter(Target==657173 & Time == 17915018)

```

```{r}
ggplot(target3, aes(x=as.character(Source), y=Time, color = as.character(Source),fill=as.character(SourceLocation))) + 
  geom_point(shape=23, size = 5)+labs(title="Travel Channel Analysis based on Target 499467",
                                    x="Source", y = "Time")
```















## Clustering:

```{r}
library(klaR)
colnames(bg6)
clusters <- kmodes(bg6[,c(3,4,6)],6,iter.max = 10, weighted = FALSE)
output <- cbind(bg6,clusters$cluster)
colnames(output)[which(names(output) == "V2")] <- "cluster"
output
```

```{r}
plot(bg6[,c(3,4,6)],col= output$cluster)
```




